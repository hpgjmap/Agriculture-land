import{cO as I,y as Q,Q as S,R as w,b4 as h}from"./index-CtmyMuv4.js";import{B as T,x as v,j as g}from"./queryUtils-CQn8Z3Yh.js";import{c as O,C as j,V as q}from"./QueryEngine-B0zIYB3I.js";import{I as E}from"./timeSupport-CR4rIiLE.js";async function C(e,i,p){const a=I(p),{point:t,distance:n,returnEdge:f,vertexMode:o}=i;if(!f&&o==="none")return{candidates:[]};let r=Q(i.query);r=await e.schedule(()=>T(r,e.definitionExpression,e.spatialReference),a),r=await e.reschedule(()=>O(r,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),a);const u=!S(t.spatialReference,e.spatialReference);u&&await v(t.spatialReference,e.spatialReference);const m=typeof n=="number"?n:n.x,d=typeof n=="number"?n:n.y,y={xmin:t.x-m,xmax:t.x+m,ymin:t.y-d,ymax:t.y+d,spatialReference:t.spatialReference},s=u?g(y,e.spatialReference):y;if(!s)return{candidates:[]};const c=(await w(h(t),null,{signal:a}))[0],x=(await w(h(s),null,{signal:a}))[0];if(c==null||x==null)return{candidates:[]};const l=new j(await e.reschedule(()=>e.searchFeatures(q(x.toJSON())),a),r,e);await e.reschedule(()=>e.executeObjectIdsQuery(l),a),await e.reschedule(()=>e.executeTimeQuery(l),a),await e.reschedule(()=>e.executeAttributesQuery(l),a),await e.reschedule(()=>M(e,l,a),a);const R=c.toJSON(),b=u?g(R,e.spatialReference):R,F=u?Math.max(s.xmax-s.xmin,s.ymax-s.ymin)/2:n;return l.createSnappingResponse({...i,point:b,distance:F},t.spatialReference)}async function M(e,i,p){var o;const{query:a}=i,{spatialRel:t}=a;if(!((o=i==null?void 0:i.items)!=null&&o.length)||!a.geometry||!t)return;const n=await E(t,a.geometry,e.geometryType,e.hasZ,e.hasM),f=await e.runSpatialFilter(i.items,r=>n(r.geometry),p);i.items=f}export{C as u};
